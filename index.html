<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Live Health Monitor</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.umd.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #45b1e7;
      --primary-dark: #3592bb;
      --bg: #f9fbfd;
      --card-bg: #fff;
      --accent: #fbbc05;
      --alert: #f44336;
      --border-radius: 16px;
      --shadow: 0 6px 24px rgba(69, 177, 231, 0.08), 0 1.5px 4px rgba(0,0,0,0.03);
      --text-main: #222;
      --text-light: #586377;
    }
    html, body { height: 100%; margin: 0; box-sizing: border-box; }
    body {
      font-family: 'Montserrat', Arial, sans-serif;
      background: linear-gradient(120deg, #f9fbfd 70%, #e6f2fb 100%);
      min-height: 100vh;
      color: var(--text-main);
      padding: 0;
    }
    header {
      background: linear-gradient(90deg, var(--primary) 60%, var(--primary-dark) 100%);
      color: white;
      padding: 32px 0 24px 0;
      border-radius: 0 0 var(--border-radius) var(--border-radius);
      box-shadow: var(--shadow);
      text-align: center;
    }
    header h1 {
      margin: 0 0 8px 0;
      font-weight: 700;
      font-size: 2.2rem;
      letter-spacing: 1px;
    }
    header p {
      margin: 0;
      font-size: 1.1rem;
      font-weight: 400;
      color: #e1f4fc;
    }
    .dashboard {
      max-width: 1100px;
      margin: -48px auto 0 auto;
      padding: 0 20px 40px 20px;
    }
    .live-section {
      display: flex;
      flex-wrap: wrap;
      gap: 28px;
      justify-content: center;
      margin-bottom: 44px;
      margin-top: 32px;
    }
    .live-card {
      background: var(--card-bg);
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      padding: 32px 40px;
      min-width: 220px;
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
      transition: box-shadow 0.3s;
    }
    .live-icon {
      font-size: 2.6rem;
      margin-bottom: 8px;
      color: var(--primary);
      filter: drop-shadow(0 1px 1px #b2e1fa);
    }
    .live-value {
      font-size: 2.7rem;
      font-weight: 700;
      margin-bottom: 0px;
      color: var(--accent);
      letter-spacing: 2px;
    }
    .live-label {
      font-size: 1rem;
      color: var(--text-light);
      font-weight: 400;
      letter-spacing: 1px;
    }
    .graph-section, .history-section {
      background: var(--card-bg);
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      padding: 32px 10px 24px 10px;
      margin: 0 auto 44px auto;
      max-width: 900px;
      margin-bottom: 40px;
    }
    .graph-section h2, .history-section h2 {
      margin-top: 0;
      font-size: 1.4rem;
      margin-bottom: 20px;
      font-weight: 600;
      color: var(--primary-dark);
      text-align: center;
    }
    .chart-container {
      width: 100%;
      overflow-x: auto;
    }
    #liveChart, #historyChart {
      min-width: 600px;
      width: 100%;
      max-width: 1800px;
      height: 320px !important;
      display: block;
      margin: 0 auto;
      background: #fafcff;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(69,177,231,0.04);
    }
    .history-controls {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 16px;
      margin-bottom: 14px;
    }
    .history-controls label {
      font-size: 1.1rem;
      font-weight: 500;
      color: var(--primary-dark);
    }
    .history-controls input[type="date"] {
      font-size: 1.1rem;
      padding: 4px 10px;
      border-radius: 6px;
      border: 1px solid #b3d4ec;
      background: #f9fbfd;
    }
    .history-table-section {
      margin: 0 auto 24px auto;
      max-width: 900px;
      background: var(--card-bg);
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      padding: 24px;
    }
    .history-table-section h3 {
      margin-top: 0;
      margin-bottom: 14px;
      font-size: 1.1rem;
      color: var(--primary-dark);
      font-weight: 600;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.97rem;
      background: #fff;
      border-radius: 10px;
      overflow: hidden;
    }
    th, td {
      padding: 8px 10px;
      text-align: center;
    }
    th {
      background: #e0ebf7;
      color: #333;
      font-weight: 600;
    }
    tr:nth-child(even) td {
      background: #f7fafc;
    }
    tr:nth-child(odd) td {
      background: #fff;
    }
    .sos-alert {
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(244,67,54,0.94);
      color: white; display: flex; align-items: center; justify-content: center;
      font-size: 2.6rem; font-weight: bold; z-index: 9999;
      animation: flash 1s infinite;
      letter-spacing: 2px;
      text-shadow: 0 2px 8px #c62828, 0 1px 0 #fff;
      flex-direction: column;
    }
    .sos-alert small {
      font-size: 1.1rem;
      font-weight: 400;
      color: #ffe3e3;
      margin-top: 14px;
    }
    .sos-ack-btn {
      margin-top: 2rem;
      padding: 0.8rem 2.5rem;
      font-size: 1.3rem;
      background: #fff;
      color: #d32f2f;
      border: none;
      border-radius: 10px;
      font-weight: 700;
      letter-spacing: 1px;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
      transition: background 0.2s, color 0.2s;
    }
    .sos-ack-btn:hover {
      background: #f6c3c3;
      color: #b71c1c;
    }
    @keyframes flash {
      0% { opacity: 1; }
      50% { opacity: 0.6; }
      100% { opacity: 1; }
    }
    .footer {
      text-align: center;
      padding: 28px 0 10px 0;
      color: #9db5c8;
      font-size: 1rem;
      background: none;
      letter-spacing: 1px;
      margin-top: 36px;
    }
    .footer a { color: var(--primary-dark); text-decoration: none; font-weight: bold; }
    ::selection { background: #b6e6ff; }
    @media (max-width: 700px) {
      .dashboard, .graph-section, .history-section, .history-table-section {
        padding-left: 2vw;
        padding-right: 2vw;
      }
      .live-section {
        gap: 12px;
      }
      #liveChart, #historyChart {
        min-width: 500px;
        height: 200px !important;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>Live Health Monitor</h1>
    <p>Track your vital signs in real time. Stay informed, stay safe.</p>
  </header>
  <div id="sosBanner" class="sos-alert" style="display:none;">
    üö® SOS TRIGGERED! üö®
    <small>Immediate attention required.</small>
    <button class="sos-ack-btn" onclick="ackSos()">Respond</button>
  </div>
  <main class="dashboard">
    <section class="live-section">
      <div class="live-card" style="--color: #fbbc05;">
        <span class="live-icon">üå°Ô∏è</span>
        <span id="live-temp" class="live-value">-- ¬∞C</span>
        <span class="live-label">Temperature</span>
      </div>
      <div class="live-card" style="--color: #45b1e7;">
        <span class="live-icon">‚ù§Ô∏è</span>
        <span id="live-bpm" class="live-value">--</span>
        <span class="live-label">Heart Rate (BPM)</span>
      </div>
      <div class="live-card" style="--color: #4caf50;">
        <span class="live-icon">ü´Å</span>
        <span id="live-co2" class="live-value">-- %</span>
        <span class="live-label">sCO‚ÇÇ (%)</span>
      </div>
    </section>
    <section class="graph-section">
      <h2>Live Vitals (Last 60 Seconds)</h2>
      <div class="chart-container">
        <canvas id="liveChart"></canvas>
      </div>
    </section>
    <section class="history-section">
      <h2>History (Hourly Averages)</h2>
      <div class="history-controls">
        <label for="history-date">Pick a date:</label>
        <input type="date" id="history-date"/>
      </div>
      <div class="chart-container">
        <canvas id="historyChart"></canvas>
      </div>
    </section>
    <section class="history-table-section">
      <h3>Last 50 Readings (Selected Date)</h3>
      <div style="overflow-x: auto;">
        <table id="historyTable">
          <thead>
            <tr>
              <th>Date & Time</th>
              <th>Temperature (¬∞C)</th>
              <th>Heart Rate (BPM)</th>
              <th>sCO‚ÇÇ (%)</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>
  </main>
  <footer class="footer">
    Inspired by leading health apps. &copy; 2025 <a href="#">HealthMonitor</a>
  </footer>
  <audio id="sos-audio" src="https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg" preload="auto"></audio>
  <script>
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyDssbC1dIiDmACxzSs9Kn-vA-cRT3MLKzk",
      authDomain: "healthmonitorapp-47655.firebaseapp.com",
      databaseURL: "https://healthmonitorapp-47655-default-rtdb.firebaseio.com",
      projectId: "healthmonitorapp-47655",
      storageBucket: "healthmonitorapp-47655.appspot.com",
      messagingSenderId: "831668449943",
      appId: "1:831668449943:web:b9ae8fdd50de8fc4d2efd2",
      measurementId: "G-BPCV50PSCF"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let sosKey = null;
    let sosActive = false;
    let sosAudioShouldLoop = false;

    // Play SOS and keep it looping regardless of new readings, until ack
    function playPersistentSosAudio() {
      const audio = document.getElementById('sos-audio');
      if (!audio) return;
      sosAudioShouldLoop = true;
      audio.currentTime = 0;
      audio.play();
      audio.onended = function() {
        if (sosAudioShouldLoop) {
          audio.currentTime = 0;
          audio.play();
        }
      };
    }
    function stopSosAudio() {
      sosAudioShouldLoop = false;
      const audio = document.getElementById('sos-audio');
      if (!audio) return;
      audio.pause();
      audio.currentTime = 0;
      audio.onended = null;
    }

    // Live value update and persistent SOS behavior
    db.ref('readings').limitToLast(1).on('value', snap => {
      if (!snap.exists()) return;
      let lastData, lastKey;
      snap.forEach(child => { lastData = child.val(); lastKey = child.key; });
      if (!lastData) return;
      document.getElementById('live-temp').textContent = (lastData.temp ? lastData.temp : "--") + " ¬∞C";
      document.getElementById('live-bpm').textContent = lastData.bpm ? lastData.bpm : "--";
      document.getElementById('live-co2').textContent = (lastData.sco2 ? lastData.sco2 : "--") + " %";
      sosKey = lastKey;
      if (lastData.sos === true && lastData.sos_ack !== true) {
        if (!sosActive) {
          sosActive = true;
          showSOS();
        }
      }
    });

    function showSOS() {
      document.getElementById('sosBanner').style.display = 'flex';
      playPersistentSosAudio();
    }
    function hideSOS() {
      document.getElementById('sosBanner').style.display = 'none';
      stopSosAudio();
      sosActive = false;
    }
    window.ackSos = async function() {
      if (sosKey) {
        await db.ref('readings/' + sosKey).update({ sos_ack: true, sos: false });
        hideSOS();
      }
    };

    // ----------- Live Chart (last 12 readings, last 60s) -----------
    let liveChart = null;
    function renderLiveChart(labels, temp, bpm, sco2) {
      const ctx = document.getElementById('liveChart').getContext('2d');
      if (liveChart) liveChart.destroy();
      liveChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets: [
            {
              label: 'Temperature (¬∞C)',
              data: temp,
              borderColor: '#fbbc05',
              backgroundColor: 'rgba(251,188,5,0.10)',
              yAxisID: 'y1',
              tension: 0.32,
              pointRadius: 2,
              borderWidth: 2,
            },
            {
              label: 'Heart Rate (BPM)',
              data: bpm,
              borderColor: '#45b1e7',
              backgroundColor: 'rgba(69,177,231,0.10)',
              yAxisID: 'y2',
              tension: 0.32,
              pointRadius: 2,
              borderWidth: 2,
            },
            {
              label: 'sCO‚ÇÇ (%)',
              data: sco2,
              borderColor: '#4caf50',
              backgroundColor: 'rgba(76,175,80,0.10)',
              yAxisID: 'y3',
              tension: 0.32,
              pointRadius: 2,
              borderWidth: 2,
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: {
              title: { display: false },
              ticks: { autoSkip: false, maxTicksLimit: 12 },
              grid: { color: "#f4f4f4" }
            },
            y1: {
              type: 'linear',
              display: true,
              position: 'left',
              title: { display: true, text: "¬∞C" },
              grid: { color: "#f8e6c3" }
            },
            y2: {
              type: 'linear',
              display: true,
              position: 'right',
              title: { display: true, text: "BPM" },
              grid: { drawOnChartArea: false }
            },
            y3: {
              type: 'linear',
              display: false,
              position: 'right',
              title: { display: true, text: "%" }
            }
          },
          plugins: {
            legend: { display: true, position: 'top' },
            tooltip: { mode: 'index', intersect: false },
            zoom: {
              pan: { enabled: true, mode: 'x', modifierKey: 'ctrl' },
              zoom: { wheel: { enabled: true }, pinch: { enabled: true }, mode: 'x' }
            }
          }
        }
      });
    }

    // Fetch last 12 readings and render live chart
    function fetchAndRenderLiveChart() {
      db.ref('readings').orderByChild('timestamp').limitToLast(12).on('value', snap => {
        if (!snap.exists()) return;
        const items = [];
        snap.forEach(child => {
          const d = child.val();
          items.push(d);
        });
        items.sort((a, b) => (a.timestamp || 0) - (b.timestamp || 0));
        const labels = [];
        const temp = [];
        const bpm = [];
        const sco2 = [];
        items.forEach(d => {
          let label = d.iso_time
            ? d.iso_time.split("T")[1].slice(0,8)
            : (d.timestamp ? new Date(Number(d.timestamp)).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' }) : "‚Äì");
          labels.push(label);
          temp.push(Number(d.temp) || null);
          bpm.push(Number(d.bpm) || null);
          sco2.push(Number(d.sco2) || null);
        });
        renderLiveChart(labels, temp, bpm, sco2);
      });
    }
    fetchAndRenderLiveChart();

    // ----------- History Chart (date picker, 24-hour average) + Table (robust) -----------

    function fetchHistoryForDate(dateStr) {
      if (!dateStr) return;
      // Calculate Nigerian day range in UTC ms
      const start = new Date(dateStr + "T00:00:00+01:00").getTime();
      const end = new Date(dateStr + "T23:59:59.999+01:00").getTime();

      db.ref('readings').orderByChild('timestamp').startAt(start).endAt(end).once('value', snap => {
        let readings = [];
        snap.forEach(child => {
          const d = child.val();
          if (d.timestamp && d.timestamp >= start && d.timestamp <= end) readings.push(d);
        });
        // Fallback: if not enough, fetch all and filter in JS
        if (readings.length < 10) {
          db.ref('readings').once('value', snap2 => {
            let allReadings = [];
            snap2.forEach(child => {
              const d = child.val();
              if (d.timestamp && d.timestamp >= start && d.timestamp <= end) allReadings.push(d);
            });
            updateHistoryTableAndChart(allReadings, dateStr);
          });
        } else {
          updateHistoryTableAndChart(readings, dateStr);
        }
      });
    }

    function updateHistoryTableAndChart(readings, dateStr) {
      readings.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
      renderHistoryTable(readings.slice(0, 50));
      // Chart: 24 hourly averages
      const {hourLabels, tempAvg, bpmAvg, sco2Avg} = computeHourlyAverages(readings);
      renderHistoryChart(hourLabels, tempAvg, bpmAvg, sco2Avg);
    }

    function renderHistoryTable(readings) {
      const tbody = document.querySelector("#historyTable tbody");
      tbody.innerHTML = "";
      readings.forEach(r => {
        const ts = r.iso_time
          ? r.iso_time.replace("T", " ").replace("+01:00","")
          : (r.timestamp ? new Date(Number(r.timestamp)).toLocaleString() : "‚Äì");
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${ts}</td>
          <td>${r.temp !== undefined ? r.temp : "--"}</td>
          <td>${r.bpm !== undefined ? r.bpm : "--"}</td>
          <td>${r.sco2 !== undefined ? r.sco2 : "--"}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    function computeHourlyAverages(readings) {
      const hourly = Array.from({length: 24}, () => []);
      readings.forEach(r => {
        if (!r.timestamp) return;
        let hour = null;
        if (r.iso_time) {
          hour = Number(r.iso_time.substr(11,2));
        } else {
          const date = new Date(Number(r.timestamp));
          hour = date.getHours();
        }
        hourly[hour].push(r);
      });
      const tempAvg = [];
      const bpmAvg = [];
      const sco2Avg = [];
      for (let h = 0; h < 24; h++) {
        const hourReadings = hourly[h];
        if (hourReadings.length === 0) {
          tempAvg.push(null);
          bpmAvg.push(null);
          sco2Avg.push(null);
        } else {
          tempAvg.push( +(hourReadings.reduce((a, b) => a + (Number(b.temp)||0), 0)/hourReadings.length).toFixed(2) );
          bpmAvg.push( +(hourReadings.reduce((a, b) => a + (Number(b.bpm)||0), 0)/hourReadings.length).toFixed(2) );
          sco2Avg.push( +(hourReadings.reduce((a, b) => a + (Number(b.sco2)||0), 0)/hourReadings.length).toFixed(2) );
        }
      }
      const hourLabels = [];
      for (let i=0; i<24; i++) hourLabels.push(i.toString().padStart(2,'0')+":00");
      return {hourLabels, tempAvg, bpmAvg, sco2Avg};
    }

    // Date picker: default to today
    function setDatePickerToday() {
      const input = document.getElementById('history-date');
      const now = new Date();
      const yyyy = now.getFullYear();
      const mm = String(now.getMonth()+1).padStart(2, '0');
      const dd = String(now.getDate()).padStart(2, '0');
      input.value = `${yyyy}-${mm}-${dd}`;
    }
    setDatePickerToday();
    fetchHistoryForDate(document.getElementById('history-date').value);

    document.getElementById('history-date').addEventListener('change', function() {
      fetchHistoryForDate(this.value);
    });
  </script>
</body>
</html>
