<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Live Health Monitor</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    /* ... (same CSS as previous answer, omitted for brevity, use previous styles) ... */
    /* Paste the CSS from the previous working web answer here */
  </style>
</head>
<body>
  <header>
    <h1>Live Health Monitor</h1>
    <p>Track your vital signs in real time. Stay informed, stay safe.</p>
  </header>
  <div id="sosBanner" class="sos-alert" style="display:none;">
    🚨 SOS TRIGGERED! 🚨
    <small>Immediate attention required.</small>
    <button class="sos-ack-btn" onclick="ackSos()">Respond</button>
  </div>
  <main class="dashboard">
    <section class="live-section">
      <div class="live-card" style="--color: #fbbc05;">
        <span class="live-icon">🌡️</span>
        <span id="live-temp" class="live-value">-- °C</span>
        <span class="live-label">Temperature</span>
      </div>
      <div class="live-card" style="--color: #45b1e7;">
        <span class="live-icon">❤️</span>
        <span id="live-bpm" class="live-value">--</span>
        <span class="live-label">Heart Rate (BPM)</span>
      </div>
      <div class="live-card" style="--color: #4caf50;">
        <span class="live-icon">🫁</span>
        <span id="live-co2" class="live-value">-- %</span>
        <span class="live-label">sCO₂ (%)</span>
      </div>
    </section>
    <section class="filter-bar">
      <label for="viewRange">View:</label>
      <select id="viewRange">
        <option value="1min">Live (1 Minute)</option>
        <option value="day">Today</option>
        <option value="week">Week</option>
        <option value="month">Month</option>
      </select>
      <input type="month" id="monthPicker" style="display: none;">
    </section>
    <section class="chart-section">
      <div class="chart-card">
        <h3>Temperature (°C)</h3>
        <canvas id="chartTemp"></canvas>
      </div>
      <div class="chart-card">
        <h3>Heart Rate (BPM)</h3>
        <canvas id="chartBPM"></canvas>
      </div>
      <div class="chart-card">
        <h3>sCO₂ (%)</h3>
        <canvas id="chartCO2"></canvas>
      </div>
    </section>
  </main>
  <footer class="footer">
    Inspired by leading health apps. &copy; 2025 <a href="#">HealthMonitor</a>
  </footer>
  <script>
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyDssbC1dIiDmACxzSs9Kn-vA-cRT3MLKzk",
      authDomain: "healthmonitorapp-47655.firebaseapp.com",
      databaseURL: "https://healthmonitorapp-47655-default-rtdb.firebaseio.com",
      projectId: "healthmonitorapp-47655",
      storageBucket: "healthmonitorapp-47655.appspot.com",
      messagingSenderId: "831668449943",
      appId: "1:831668449943:web:b9ae8fdd50de8fc4d2efd2",
      measurementId: "G-BPCV50PSCF"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    function getBarColors(baseColor, highlightColor, len) {
      return Array.from({length: len-1}, () => baseColor).concat([highlightColor]);
    }

    const charts = {
      temp: new Chart(document.getElementById('chartTemp'), {
        type: 'bar',
        data: { labels: [], datasets: [{ label: 'Temperature (°C)', data: [], backgroundColor: [] }] },
        options: {
          responsive: true,
          animation: { duration: 700 },
          plugins: {
            legend: { display: false },
            title: { display: false }
          },
          scales: {
            x: {
              grid: { color: "#f0f6fa" },
              ticks: { color: "#8aa6be", font: { size: 13, weight: 600 } }
            },
            y: {
              beginAtZero: true,
              suggestedMin: 20,
              suggestedMax: 45,
              grid: { color: "#f0f6fa" },
              ticks: { color: "#8aa6be", font: { size: 13, weight: 600 } }
            }
          }
        }
      }),
      bpm: new Chart(document.getElementById('chartBPM'), {
        type: 'bar',
        data: { labels: [], datasets: [{ label: 'Heart Rate (BPM)', data: [], backgroundColor: [] }] },
        options: {
          responsive: true,
          animation: { duration: 700 },
          plugins: {
            legend: { display: false },
            title: { display: false }
          },
          scales: {
            x: {
              grid: { color: "#f0f6fa" },
              ticks: { color: "#8aa6be", font: { size: 13, weight: 600 } }
            },
            y: {
              beginAtZero: true,
              suggestedMin: 50,
              suggestedMax: 150,
              grid: { color: "#f0f6fa" },
              ticks: { color: "#8aa6be", font: { size: 13, weight: 600 } }
            }
          }
        }
      }),
      co2: new Chart(document.getElementById('chartCO2'), {
        type: 'bar',
        data: { labels: [], datasets: [{ label: 'sCO₂ (%)', data: [], backgroundColor: [] }] },
        options: {
          responsive: true,
          animation: { duration: 700 },
          plugins: {
            legend: { display: false },
            title: { display: false }
          },
          scales: {
            x: {
              grid: { color: "#f0f6fa" },
              ticks: { color: "#8aa6be", font: { size: 13, weight: 600 } }
            },
            y: {
              beginAtZero: true,
              suggestedMin: 60,
              suggestedMax: 100,
              grid: { color: "#f0f6fa" },
              ticks: { color: "#8aa6be", font: { size: 13, weight: 600 } }
            }
          }
        }
      })
    };

    let sosKey = null;

    const viewSelect = document.getElementById('viewRange');
    const monthPicker = document.getElementById('monthPicker');

    viewSelect.addEventListener('change', () => {
      monthPicker.style.display = viewSelect.value === 'month' ? 'inline-block' : 'none';
      loadData();
    });
    monthPicker.addEventListener('change', loadData);

    function formatHour(hour) {
      const h = hour % 12 || 12;
      const ampm = hour < 12 ? "am" : "pm";
      return `${h}${ampm}`;
    }

    function updateChart(chart, labels, values, color, highlight) {
      chart.data.labels = labels;
      chart.data.datasets[0].data = values.map(v => v===null?null:parseFloat(v));
      chart.data.datasets[0].backgroundColor = getBarColors(color, highlight, values.length);
      chart.update();
    }

    // Listen to all readings for latest and SOS
    db.ref('readings').limitToLast(1).on('child_added', snapshot => {
      const data = snapshot.val();
      sosKey = snapshot.key;
      if (!data) return;
      document.getElementById('live-temp').textContent = (data.temp ? data.temp : "--") + " °C";
      document.getElementById('live-bpm').textContent = data.bpm ? data.bpm : "--";
      document.getElementById('live-co2').textContent = (data.sco2 ? data.sco2 : "--") + " %";
      // SOS Banner
      if (data.sos === true && data.sos_ack !== true) {
        showSOS();
      } else {
        hideSOS();
      }
    });

    function showSOS() {
      document.getElementById('sosBanner').style.display = 'flex';
      if (!window.sosAudioPlayed) {
        const audio = new Audio('https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg');
        audio.play();
        window.sosAudioPlayed = true;
      }
    }
    function hideSOS() {
      document.getElementById('sosBanner').style.display = 'none';
      window.sosAudioPlayed = false;
    }
    // Acknowledge SOS
    window.ackSos = async function() {
      if (sosKey) {
        await db.ref('readings/' + sosKey).update({ sos_ack: true, sos: false });
        hideSOS();
      }
    };

    async function loadData() {
      const now = new Date();
      const view = viewSelect.value;
      const snap = await db.ref('readings').orderByChild('timestamp').limitToLast(500).get();

      if (view === '1min') {
        let nowTs = Date.now();
        let slots = Array.from({length:12}, (_,i)=>nowTs - (11-i)*5000);
        let barData = Array.from({length:12}, ()=>[]);
        snap.forEach(child => {
          const data = child.val();
          const ts = typeof data.timestamp === "number" ? data.timestamp : new Date(data.timestamp).getTime();
          for(let i=0;i<12;i++) {
            if(ts >= slots[i] && ts < slots[i]+5000) {
              barData[i].push(data);
              break;
            }
          }
        });
        const labels = Array.from({length:12}, (_,i)=>`${(i-11)*5<0?-(i-11)*5:0}s ago`).reverse();
        const temps = barData.map(arr=>arr.length?((arr.reduce((a,b)=>a+Number(b.temp),0))/arr.length).toFixed(1):null);
        const bpms  = barData.map(arr=>arr.length?((arr.reduce((a,b)=>a+Number(b.bpm),0))/arr.length).toFixed(1):null);
        const co2s  = barData.map(arr=>arr.length?((arr.reduce((a,b)=>a+Number(b.sco2),0))/arr.length).toFixed(1):null);
        updateChart(charts.temp, labels, temps, "#fbbc05", "#e53935");
        updateChart(charts.bpm, labels, bpms, "#45b1e7", "#1976d2");
        updateChart(charts.co2, labels, co2s, "#4caf50", "#009688");
        return;
      }

      if (view === "day") {
        let bars = Array.from({length:24}, ()=>[]);
        snap.forEach(child => {
          const data = child.val();
          const ts = new Date(data.timestamp);
          if (ts.toDateString() !== now.toDateString()) return;
          bars[ts.getHours()].push(data);
        });
        const labels = Array.from({length:24}, (_,i)=>formatHour(i));
        const temps = bars.map(arr=>arr.length?((arr.reduce((a,b)=>a+Number(b.temp),0))/arr.length).toFixed(1):null);
        const bpms  = bars.map(arr=>arr.length?((arr.reduce((a,b)=>a+Number(b.bpm),0))/arr.length).toFixed(1):null);
        const co2s  = bars.map(arr=>arr.length?((arr.reduce((a,b)=>a+Number(b.sco2),0))/arr.length).toFixed(1):null);
        updateChart(charts.temp, labels, temps, "#fbbc05", "#e53935");
        updateChart(charts.bpm, labels, bpms, "#45b1e7", "#1976d2");
        updateChart(charts.co2, labels, co2s, "#4caf50", "#009688");
        return;
      }

      if (view==="week") {
        let weekAgo = new Date(now);
        weekAgo.setHours(0,0,0,0);
        weekAgo.setDate(now.getDate()-6);
        let days = Array.from({length:7}, ()=>[]);
        snap.forEach(child => {
          const data = child.val();
          const ts = new Date(data.timestamp);
          if (ts >= weekAgo && ts <= now) {
            let dayIdx = Math.floor((ts-weekAgo)/(24*60*60*1000));
            days[dayIdx].push(data);
          }
        });
        let dayNames = [];
        for(let i=0;i<7;i++) {
          let d = new Date(weekAgo);
          d.setDate(weekAgo.getDate()+i);
          dayNames.push(d.toLocaleDateString(undefined, {weekday:"short"}));
        }
        const temps = days.map(arr=>arr.length?((arr.reduce((a,b)=>a+Number(b.temp),0))/arr.length).toFixed(1):null);
        const bpms  = days.map(arr=>arr.length?((arr.reduce((a,b)=>a+Number(b.bpm),0))/arr.length).toFixed(1):null);
        const co2s  = days.map(arr=>arr.length?((arr.reduce((a,b)=>a+Number(b.sco2),0))/arr.length).toFixed(1):null);
        updateChart(charts.temp, dayNames, temps, "#fbbc05", "#e53935");
        updateChart(charts.bpm, dayNames, bpms, "#45b1e7", "#1976d2");
        updateChart(charts.co2, dayNames, co2s, "#4caf50", "#009688");
        return;
      }

      if (view==="month") {
        if (!monthPicker.value) {
          updateChart(charts.temp, [], [], "#fbbc05", "#e53935");
          updateChart(charts.bpm, [], [], "#45b1e7", "#1976d2");
          updateChart(charts.co2, [], [], "#4caf50", "#009688");
          return;
        }
        const [yyyy,mm]=monthPicker.value.split("-");
        const selectedMonth = new Date(Number(yyyy), Number(mm)-1, 1);
        let daysInMonth = new Date(Number(yyyy), Number(mm), 0).getDate();
        let bars = Array.from({length:daysInMonth}, ()=>[]);
        snap.forEach(child => {
          const data = child.val();
          const ts = new Date(data.timestamp);
          if (ts.getMonth()!==selectedMonth.getMonth() || ts.getFullYear()!==selectedMonth.getFullYear()) return;
          bars[ts.getDate()-1].push(data);
        });
        const labels = Array.from({length:daysInMonth}, (_,i)=>(i+1).toString());
        const temps = bars.map(arr=>arr.length?((arr.reduce((a,b)=>a+Number(b.temp),0))/arr.length).toFixed(1):null);
        const bpms  = bars.map(arr=>arr.length?((arr.reduce((a,b)=>a+Number(b.bpm),0))/arr.length).toFixed(1):null);
        const co2s  = bars.map(arr=>arr.length?((arr.reduce((a,b)=>a+Number(b.sco2),0))/arr.length).toFixed(1):null);
        updateChart(charts.temp, labels, temps, "#fbbc05", "#e53935");
        updateChart(charts.bpm, labels, bpms, "#45b1e7", "#1976d2");
        updateChart(charts.co2, labels, co2s, "#4caf50", "#009688");
        return;
      }
    }

    setInterval(loadData, 3000);
    loadData();
  </script>
</body>
</html>
