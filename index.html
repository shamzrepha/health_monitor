<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Live Health Monitor</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #45b1e7;
      --primary-dark: #3592bb;
      --bg: #f9fbfd;
      --card-bg: #fff;
      --accent: #fbbc05;
      --alert: #f44336;
      --border-radius: 16px;
      --shadow: 0 6px 24px rgba(69, 177, 231, 0.08), 0 1.5px 4px rgba(0,0,0,0.03);
      --text-main: #222;
      --text-light: #586377;
    }

    html, body {
      height: 100%;
      margin: 0;
      box-sizing: border-box;
    }
    body {
      font-family: 'Montserrat', Arial, sans-serif;
      background: linear-gradient(120deg, #f9fbfd 70%, #e6f2fb 100%);
      min-height: 100vh;
      color: var(--text-main);
      padding: 0;
    }
    header {
      background: linear-gradient(90deg, var(--primary) 60%, var(--primary-dark) 100%);
      color: white;
      padding: 32px 0 24px 0;
      border-radius: 0 0 var(--border-radius) var(--border-radius);
      box-shadow: var(--shadow);
      text-align: center;
    }
    header h1 {
      margin: 0 0 8px 0;
      font-weight: 700;
      font-size: 2.2rem;
      letter-spacing: 1px;
    }
    header p {
      margin: 0;
      font-size: 1.1rem;
      font-weight: 400;
      color: #e1f4fc;
    }

    .dashboard {
      max-width: 1100px;
      margin: -48px auto 0 auto;
      padding: 0 20px 40px 20px;
    }
    .live-section {
      display: flex;
      flex-wrap: wrap;
      gap: 28px;
      justify-content: center;
      margin-bottom: 44px;
      margin-top: 32px;
    }
    .live-card {
      background: var(--card-bg);
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      padding: 32px 40px;
      min-width: 220px;
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
      transition: box-shadow 0.3s;
    }
    .live-card:not(:last-child)::after {
      content: '';
      position: absolute;
      right: -18px;
      top: 50%;
      transform: translateY(-50%);
      width: 2px;
      height: 40px;
      background: #e3eef8;
      border-radius: 3px;
      display: none;
    }
    @media (min-width: 700px) {
      .live-card:not(:last-child)::after {
        display: block;
      }
    }
    .live-icon {
      font-size: 2.6rem;
      margin-bottom: 8px;
      color: var(--primary);
      filter: drop-shadow(0 1px 1px #b2e1fa);
    }
    .live-value {
      font-size: 2.7rem;
      font-weight: 700;
      margin-bottom: 0px;
      color: var(--accent);
      letter-spacing: 2px;
    }
    .live-label {
      font-size: 1rem;
      color: var(--text-light);
      font-weight: 400;
      letter-spacing: 1px;
    }

    .filter-bar {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 18px;
      margin-bottom: 32px;
      flex-wrap: wrap;
    }
    .filter-bar label {
      font-size: 1.1rem;
      color: var(--primary-dark);
      font-weight: 600;
    }
    .filter-bar select, .filter-bar input[type="month"] {
      font-size: 1.1rem;
      padding: 7px 16px;
      border-radius: 8px;
      border: 1px solid #c7e3f6;
      background: #eaf7ff;
      color: var(--primary-dark);
      outline: none;
      transition: border 0.2s;
      font-family: inherit;
    }
    .filter-bar select:focus, .filter-bar input[type="month"]:focus {
      border: 1.5px solid var(--primary);
    }

    .chart-section {
      display: grid;
      grid-template-columns: 1fr;
      gap: 28px;
      max-width: 900px;
      margin: 0 auto;
    }
    @media (min-width: 900px) {
      .chart-section {
        grid-template-columns: 1fr 1fr 1fr;
      }
    }
    .chart-card {
      background: var(--card-bg);
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      padding: 28px 18px 22px 18px;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 320px;
      position: relative;
    }
    .chart-card h3 {
      margin: 0 0 14px 0;
      color: var(--primary-dark);
      font-size: 1.2rem;
      letter-spacing: 1px;
      font-weight: 600;
    }
    .chart-card canvas {
      width: 100% !important;
      max-width: 340px;
      max-height: 180px;
    }

    .sos-alert {
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(244,67,54,0.94);
      color: white; display: flex; align-items: center; justify-content: center;
      font-size: 2.6rem; font-weight: bold; z-index: 9999;
      animation: flash 1s infinite;
      letter-spacing: 2px;
      text-shadow: 0 2px 8px #c62828, 0 1px 0 #fff;
      flex-direction: column;
    }
    .sos-alert small {
      font-size: 1.1rem;
      font-weight: 400;
      color: #ffe3e3;
      margin-top: 14px;
    }
    @keyframes flash {
      0% { opacity: 1; }
      50% { opacity: 0.6; }
      100% { opacity: 1; }
    }

    .footer {
      text-align: center;
      padding: 28px 0 10px 0;
      color: #9db5c8;
      font-size: 1rem;
      background: none;
      letter-spacing: 1px;
      margin-top: 36px;
    }
    .footer a { color: var(--primary-dark); text-decoration: none; font-weight: bold; }
    ::selection { background: #b6e6ff; }
  </style>
</head>
<body>
  <header>
    <h1>Live Health Monitor</h1>
    <p>Track your vital signs in real time. Stay informed, stay safe.</p>
  </header>
  <div id="sosBanner" class="sos-alert" style="display:none;">
    üö® SOS TRIGGERED! üö®
    <small>Immediate attention required.</small>
  </div>
  <main class="dashboard">
    <section class="live-section">
      <div class="live-card" style="--color: #fbbc05;">
        <span class="live-icon">üå°Ô∏è</span>
        <span id="live-temp" class="live-value">-- ¬∞C</span>
        <span class="live-label">Temperature</span>
      </div>
      <div class="live-card" style="--color: #45b1e7;">
        <span class="live-icon">‚ù§Ô∏è</span>
        <span id="live-bpm" class="live-value">--</span>
        <span class="live-label">Heart Rate (BPM)</span>
      </div>
      <div class="live-card" style="--color: #4caf50;">
        <span class="live-icon">ü´Å</span>
        <span id="live-co2" class="live-value">-- %</span>
        <span class="live-label">sCO‚ÇÇ (%)</span>
      </div>
    </section>
    <section class="filter-bar">
      <label for="viewRange">View:</label>
      <select id="viewRange">
        <option value="1min">Live (1 Minute)</option>
        <option value="day">Today</option>
        <option value="week">Week</option>
        <option value="month">Month</option>
      </select>
      <input type="month" id="monthPicker" style="display: none;">
    </section>
    <section class="chart-section">
      <div class="chart-card">
        <h3>Temperature (¬∞C)</h3>
        <canvas id="chartTemp"></canvas>
      </div>
      <div class="chart-card">
        <h3>Heart Rate (BPM)</h3>
        <canvas id="chartBPM"></canvas>
      </div>
      <div class="chart-card">
        <h3>sCO‚ÇÇ (%)</h3>
        <canvas id="chartCO2"></canvas>
      </div>
    </section>
  </main>
  <footer class="footer">
    Inspired by leading health apps. &copy; 2025 <a href="#">HealthMonitor</a>
  </footer>
  <script>
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyDssbC1dIiDmACxzSs9Kn-vA-cRT3MLKzk",
      authDomain: "healthmonitorapp-47655.firebaseapp.com",
      databaseURL: "https://healthmonitorapp-47655-default-rtdb.firebaseio.com",
      projectId: "healthmonitorapp-47655",
      storageBucket: "healthmonitorapp-47655.appspot.com",
      messagingSenderId: "831668449943",
      appId: "1:831668449943:web:b9ae8fdd50de8fc4d2efd2",
      measurementId: "G-BPCV50PSCF"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // Chart.js options
    const chartOptions = (color, yMin, yMax, label) => ({
      type: 'bar',
      data: { labels: [], datasets: [{ label: label, data: [], backgroundColor: color, borderRadius: 8, barPercentage: 0.7, categoryPercentage: 0.7 }] },
      options: {
        responsive: true,
        animation: { duration: 700 },
        plugins: {
          legend: { display: false },
          title: { display: false },
          tooltip: {
            callbacks: {
              label: (ctx) => ctx.dataset.label + ": " + ctx.formattedValue
            }
          }
        },
        scales: {
          x: {
            title: { display: false },
            grid: { color: "#f0f6fa" },
            ticks: { color: "#8aa6be", font: { size: 13, weight: 600 } }
          },
          y: {
            beginAtZero: true,
            suggestedMin: yMin,
            suggestedMax: yMax,
            title: { display: false },
            grid: { color: "#f0f6fa" },
            ticks: { color: "#8aa6be", font: { size: 13, weight: 600 } }
          }
        }
      }
    });

    // Proper value mapping for each chart
    const charts = {
      temp: new Chart(document.getElementById('chartTemp'), chartOptions('#fbbc05', 20, 45, 'Temperature (¬∞C)')),
      bpm: new Chart(document.getElementById('chartBPM'), chartOptions('#45b1e7', 50, 150, 'Heart Rate (BPM)')),
      co2: new Chart(document.getElementById('chartCO2'), chartOptions('#4caf50', 60, 100, 'sCO‚ÇÇ (%)'))
    };

    const viewSelect = document.getElementById('viewRange');
    const monthPicker = document.getElementById('monthPicker');

    viewSelect.addEventListener('change', () => {
      monthPicker.style.display = viewSelect.value === 'month' ? 'inline-block' : 'none';
      loadData();
    });
    monthPicker.addEventListener('change', loadData);

    // LIVE updating section
    db.ref('readings').limitToLast(1).on('child_added', snapshot => {
      const data = snapshot.val();
      if (!data) return;
      document.getElementById('live-temp').textContent = (data.temp ? data.temp : "--") + " ¬∞C";
      document.getElementById('live-bpm').textContent = data.bpm ? data.bpm : "--";
      document.getElementById('live-co2').textContent = (data.sco2 ? data.sco2 : "--") + " %";
      // SOS Banner
      if (data.sos === true) {
        document.getElementById('sosBanner').style.display = 'flex';
        const audio = new Audio('https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg');
        audio.play();
      } else {
        document.getElementById('sosBanner').style.display = 'none';
      }
    });

    async function loadData() {
      const now = new Date();
      const view = viewSelect.value;
      const snap = await db.ref('readings').orderByChild('timestamp').limitToLast(300).get();

      const groups = {};
      snap.forEach(child => {
        const data = child.val();
        const ts = new Date(data.timestamp);

        if (view === '1min') {
          if ((now - ts) > 60000) return;
          const slot = Math.floor((now - ts) / 5000);
          const label = `${60 - slot*5}s ago`;
          groups[label] = groups[label] || [];
          groups[label].push(data);
        } else if (view === 'day') {
          if (ts.toDateString() !== now.toDateString()) return;
          const hour = ts.getHours();
          groups[hour] = groups[hour] || [];
          groups[hour].push(data);
        } else if (view === 'week') {
          const weekAgo = new Date();
          weekAgo.setDate(now.getDate() - 7);
          if (ts < weekAgo) return;
          const weekday = ts.toLocaleDateString(undefined, { weekday: 'short' });
          groups[weekday] = groups[weekday] || [];
          groups[weekday].push(data);
        } else if (view === 'month') {
          const selected = new Date(monthPicker.value);
          if (!monthPicker.value || ts.getMonth() !== selected.getMonth() || ts.getFullYear() !== selected.getFullYear()) return;
          const day = ts.getDate();
          groups[day] = groups[day] || [];
          groups[day].push(data);
        }
      });

      const labels = Object.keys(groups).sort((a, b) => {
        const aNum = Number(a), bNum = Number(b);
        return (!isNaN(aNum) && !isNaN(bNum)) ? aNum - bNum : a.localeCompare(b);
      });
      const temps = [], bpms = [], co2s = [];

      labels.forEach(label => {
        const group = groups[label];
        const avg = arr => arr.reduce((a, b) => a + parseFloat(b || 0), 0) / arr.length;
        temps.push(avg(group.map(x => x.temp)).toFixed(1));
        bpms.push(avg(group.map(x => x.bpm)).toFixed(1));
        co2s.push(avg(group.map(x => x.sco2)).toFixed(1));
      });

      updateChart(charts.temp, labels, temps);
      updateChart(charts.bpm, labels, bpms);
      updateChart(charts.co2, labels, co2s);
    }

    function updateChart(chart, labels, values) {
      chart.data.labels = labels;
      chart.data.datasets[0].data = values.map(v => parseFloat(v));
      chart.update();
    }

    setInterval(loadData, 3000);
    loadData();
  </script>
</body>
</html>
