<!-- ... (keep all previous HTML up to the <script> tag) ... -->
<script>
  // (Firebase config and initialization stay the same)

  // Chart.js options with dynamic color for the latest bar
  function getBarColors(baseColor, highlightColor, len) {
    // All bars are baseColor except the last (latest), which is highlightColor
    return Array.from({length: len-1}, () => baseColor).concat([highlightColor]);
  }

  const charts = {
    temp: new Chart(document.getElementById('chartTemp'), {
      type: 'bar',
      data: { labels: [], datasets: [{ label: 'Temperature (°C)', data: [], backgroundColor: [] }] },
      options: {
        responsive: true,
        animation: { duration: 700 },
        plugins: {
          legend: { display: false },
          title: { display: false }
        },
        scales: {
          x: {
            grid: { color: "#f0f6fa" },
            ticks: { color: "#8aa6be", font: { size: 13, weight: 600 } }
          },
          y: {
            beginAtZero: true,
            suggestedMin: 20,
            suggestedMax: 45,
            grid: { color: "#f0f6fa" },
            ticks: { color: "#8aa6be", font: { size: 13, weight: 600 } }
          }
        }
      }
    }),
    bpm: new Chart(document.getElementById('chartBPM'), {
      type: 'bar',
      data: { labels: [], datasets: [{ label: 'Heart Rate (BPM)', data: [], backgroundColor: [] }] },
      options: {
        responsive: true,
        animation: { duration: 700 },
        plugins: {
          legend: { display: false },
          title: { display: false }
        },
        scales: {
          x: {
            grid: { color: "#f0f6fa" },
            ticks: { color: "#8aa6be", font: { size: 13, weight: 600 } }
          },
          y: {
            beginAtZero: true,
            suggestedMin: 50,
            suggestedMax: 150,
            grid: { color: "#f0f6fa" },
            ticks: { color: "#8aa6be", font: { size: 13, weight: 600 } }
          }
        }
      }
    }),
    co2: new Chart(document.getElementById('chartCO2'), {
      type: 'bar',
      data: { labels: [], datasets: [{ label: 'sCO₂ (%)', data: [], backgroundColor: [] }] },
      options: {
        responsive: true,
        animation: { duration: 700 },
        plugins: {
          legend: { display: false },
          title: { display: false }
        },
        scales: {
          x: {
            grid: { color: "#f0f6fa" },
            ticks: { color: "#8aa6be", font: { size: 13, weight: 600 } }
          },
          y: {
            beginAtZero: true,
            suggestedMin: 60,
            suggestedMax: 100,
            grid: { color: "#f0f6fa" },
            ticks: { color: "#8aa6be", font: { size: 13, weight: 600 } }
          }
        }
      }
    })
  };

  // Helper for hour labels
  function formatHour(hour) {
    const h = hour % 12 || 12;
    const ampm = hour < 12 ? "am" : "pm";
    return `${h}${ampm}`;
  }

  // Update chart with highlighted latest bar
  function updateChart(chart, labels, values, color, highlight) {
    chart.data.labels = labels;
    chart.data.datasets[0].data = values.map(v => v===null?null:parseFloat(v));
    // Set color: all bars base except latest (right-most)
    chart.data.datasets[0].backgroundColor = getBarColors(color, highlight, values.length);
    chart.update();
  }

  // ------- (LIVE updating and loadData logic remains the same, but change updateChart calls) --------

  async function loadData() {
    const now = new Date();
    const view = viewSelect.value;
    const snap = await db.ref('readings').orderByChild('timestamp').limitToLast(400).get();

    // 1min view: 12 bars
    if (view === '1min') {
      let nowTs = Date.now();
      let slots = Array.from({length:12}, (_,i)=>nowTs - (11-i)*5000);
      let barData = Array.from({length:12}, ()=>[]);
      snap.forEach(child => {
        const data = child.val();
        const ts = typeof data.timestamp === "number" ? data.timestamp : new Date(data.timestamp).getTime();
        for(let i=0;i<12;i++) {
          if(ts >= slots[i] && ts < slots[i]+5000) {
            barData[i].push(data);
            break;
          }
        }
      });
      const labels = Array.from({length:12}, (_,i)=>`${(i-11)*5<0?-(i-11)*5:0}s ago`).reverse();
      const temps = barData.map(arr=>arr.length?((arr.reduce((a,b)=>a+Number(b.temp),0))/arr.length).toFixed(1):null);
      const bpms  = barData.map(arr=>arr.length?((arr.reduce((a,b)=>a+Number(b.bpm),0))/arr.length).toFixed(1):null);
      const co2s  = barData.map(arr=>arr.length?((arr.reduce((a,b)=>a+Number(b.sco2),0))/arr.length).toFixed(1):null);
      updateChart(charts.temp, labels, temps, "#fbbc05", "#e53935"); // yellow base, red highlight
      updateChart(charts.bpm, labels, bpms, "#45b1e7", "#1976d2");  // blue base, strong blue highlight
      updateChart(charts.co2, labels, co2s, "#4caf50", "#009688");  // green base, teal highlight
      return;
    }

    // Day: 24 bars
    if (view === "day") {
      let bars = Array.from({length:24}, ()=>[]);
      snap.forEach(child => {
        const data = child.val();
        const ts = new Date(data.timestamp);
        if (ts.toDateString() !== now.toDateString()) return;
        bars[ts.getHours()].push(data);
      });
      const labels = Array.from({length:24}, (_,i)=>formatHour(i));
      const temps = bars.map(arr=>arr.length?((arr.reduce((a,b)=>a+Number(b.temp),0))/arr.length).toFixed(1):null);
      const bpms  = bars.map(arr=>arr.length?((arr.reduce((a,b)=>a+Number(b.bpm),0))/arr.length).toFixed(1):null);
      const co2s  = bars.map(arr=>arr.length?((arr.reduce((a,b)=>a+Number(b.sco2),0))/arr.length).toFixed(1):null);
      updateChart(charts.temp, labels, temps, "#fbbc05", "#e53935");
      updateChart(charts.bpm, labels, bpms, "#45b1e7", "#1976d2");
      updateChart(charts.co2, labels, co2s, "#4caf50", "#009688");
      return;
    }

    // Week: 7 bars
    if (view==="week") {
      let weekAgo = new Date(now);
      weekAgo.setHours(0,0,0,0);
      weekAgo.setDate(now.getDate()-6);
      let days = Array.from({length:7}, ()=>[]);
      snap.forEach(child => {
        const data = child.val();
        const ts = new Date(data.timestamp);
        if (ts >= weekAgo && ts <= now) {
          let dayIdx = Math.floor((ts-weekAgo)/(24*60*60*1000));
          days[dayIdx].push(data);
        }
      });
      let dayNames = [];
      for(let i=0;i<7;i++) {
        let d = new Date(weekAgo);
        d.setDate(weekAgo.getDate()+i);
        dayNames.push(d.toLocaleDateString(undefined, {weekday:"short"}));
      }
      const temps = days.map(arr=>arr.length?((arr.reduce((a,b)=>a+Number(b.temp),0))/arr.length).toFixed(1):null);
      const bpms  = days.map(arr=>arr.length?((arr.reduce((a,b)=>a+Number(b.bpm),0))/arr.length).toFixed(1):null);
      const co2s  = days.map(arr=>arr.length?((arr.reduce((a,b)=>a+Number(b.sco2),0))/arr.length).toFixed(1):null);
      updateChart(charts.temp, dayNames, temps, "#fbbc05", "#e53935");
      updateChart(charts.bpm, dayNames, bpms, "#45b1e7", "#1976d2");
      updateChart(charts.co2, dayNames, co2s, "#4caf50", "#009688");
      return;
    }

    // Month: bars for days in month
    if (view==="month") {
      if (!monthPicker.value) {
        updateChart(charts.temp, [], [], "#fbbc05", "#e53935");
        updateChart(charts.bpm, [], [], "#45b1e7", "#1976d2");
        updateChart(charts.co2, [], [], "#4caf50", "#009688");
        return;
      }
      const [yyyy,mm]=monthPicker.value.split("-");
      const selectedMonth = new Date(Number(yyyy), Number(mm)-1, 1);
      let daysInMonth = new Date(Number(yyyy), Number(mm), 0).getDate();
      let bars = Array.from({length:daysInMonth}, ()=>[]);
      snap.forEach(child => {
        const data = child.val();
        const ts = new Date(data.timestamp);
        if (ts.getMonth()!==selectedMonth.getMonth() || ts.getFullYear()!==selectedMonth.getFullYear()) return;
        bars[ts.getDate()-1].push(data);
      });
      const labels = Array.from({length:daysInMonth}, (_,i)=>(i+1).toString());
      const temps = bars.map(arr=>arr.length?((arr.reduce((a,b)=>a+Number(b.temp),0))/arr.length).toFixed(1):null);
      const bpms  = bars.map(arr=>arr.length?((arr.reduce((a,b)=>a+Number(b.bpm),0))/arr.length).toFixed(1):null);
      const co2s  = bars.map(arr=>arr.length?((arr.reduce((a,b)=>a+Number(b.sco2),0))/arr.length).toFixed(1):null);
      updateChart(charts.temp, labels, temps, "#fbbc05", "#e53935");
      updateChart(charts.bpm, labels, bpms, "#45b1e7", "#1976d2");
      updateChart(charts.co2, labels, co2s, "#4caf50", "#009688");
      return;
    }
  }

  setInterval(loadData, 3000);
  loadData();

  // LIVE section and SOS Banner remain unchanged
</script>
