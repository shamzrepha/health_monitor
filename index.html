<!DOCTYPE html>
<html>
<head>
  <title>Health Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <h1>Patient Health Monitoring</h1>
  <label for="chart-date">Select Date:</label>
  <input type="date" id="chart-date">
  <select id="range">
    <option value="hour">Hourly</option>
    <option value="day" selected>Daily</option>
    <option value="week">Weekly</option>
    <option value="month">Monthly</option>
  </select>
  <button onclick="loadChart()">Update Chart</button>
  <canvas id="healthChart" width="800" height="350"></canvas>
  <script>
    // Set default date to today
    document.getElementById('chart-date').valueAsDate = new Date();

    async function loadChart() {
      const date = document.getElementById('chart-date').value;
      const range = document.getElementById('range').value;
      const resp = await fetch(`/api/chartdata/patient1?range=${range}&date=${date}`);
      const data = await resp.json();

      const labels = data.map(d => {
        const dt = new Date(d.timestamp);
        if (range === "hour") {
          return dt.getHours() + ':' + dt.getMinutes().toString().padStart(2, '0');
        } else if (range === "day") {
          return dt.getHours() + ":00";
        } else if (range === "week" || range === "month") {
          return dt.toLocaleDateString();
        }
        return dt.toLocaleString();
      });

      const temp = data.map(d => d.temperature);
      const hr = data.map(d => d.heart_rate);
      const spo2 = data.map(d => d.spo2);

      chart.data.labels = labels;
      chart.data.datasets[0].data = temp;
      chart.data.datasets[1].data = hr;
      chart.data.datasets[2].data = spo2;
      chart.update();
    }

    const ctx = document.getElementById('healthChart').getContext('2d');
    const chart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: [],
        datasets: [
          { label: 'Temperature (°C)', borderColor: 'red', data: [], fill: false, yAxisID: 'y' },
          { label: 'Heart Rate (bpm)', borderColor: 'blue', data: [], fill: false, yAxisID: 'y1' },
          { label: 'SpO₂ (%)', borderColor: 'green', data: [], fill: false, yAxisID: 'y2' }
        ]
      },
      options: {
        responsive: false,
        scales: {
          y: { type: 'linear', display: true, position: 'left', title: { display: true, text: 'Temp (°C)' } },
          y1: { type: 'linear', display: true, position: 'right', title: { display: true, text: 'Heart Rate (bpm)' }, grid: { drawOnChartArea: false } },
          y2: { type: 'linear', display: false }
        }
      }
    });

    loadChart();
    setInterval(loadChart, 60000); // Refresh every minute
  </script>
</body>
</html>
